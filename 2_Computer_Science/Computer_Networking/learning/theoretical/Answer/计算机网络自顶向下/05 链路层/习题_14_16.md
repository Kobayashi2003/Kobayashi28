#### P14 如图 5-33 所示，考虑通过两台路由器互联的 3 个局域网。
#### a. 对所有接口分配 IP 地址。对子网 1 使用形式为 192.168.1.xxx 的地址，对子网 2 使用形式为 192.168.2.xxx 的地址，对子网 3 使用形式为 192.168.3.xxx 的地址。
#### b. 为所有适配器分配 MAC 地址。
#### c. 考虑从主机 E 向主机 B 发送一个 IP 数据报。假设所有 ARP 表都是最新的。就像在 5.4.1 节中对单路路由器例子所做的那样，列出所有步骤。
#### d. 重复 (c)，现在假设在发送主机中的 ARP 表为空（并且其他表都是最新的）。

![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/p14.png)

  * a.
    * ![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/p14.1.png)

  * b.
    * ![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/p14.2.png)
    
  * c.
    * E 的链路层打包网络层数据报，因为 B 的 IP 192.168.1.1 是跨网段的，所以E 从 ARP 表中找出网关路由器 R2 的 IP 192.168.3.1 (从 DHCP ACK 报文中获得) 对应的的 MAC 地址 HH-HH-HH-HH-HH-HH 作为目的 MAC 地址。
    
    * E 将该帧发到局域网中。
    
    * E 所在局域网的交换机 S3 收到该帧，于是检查自己的交换表，若其中有网关路由器 MAC 地址对应的表项，那么就转发到指定端口。若没有，那么向除了来路外的所有端口广播该帧，于是 F 将收到该帧，F 的适配器检查到该帧不是向自己寻址后将其丢弃。
    
    * 接下来网关路由器 R3 的适配器收到了该帧，确认了是向自己寻址的帧后，拆封向上交给网络层，于是检查自己的转发表，决定恰当的端口进行转发。
    
    * 在路由器恰当的输出端口适配器中，由于路由器的 ARP 表是最新的，所以路由器查找到了下一跳路由器 R1 的 MAC 地址 DD-DD-DD-DD-DD-DD，将其作为帧的目的 MAC，然后转发出去。
    
    * 当中间的交换机 S2 收到此帧，检查自己的交换表，有记录则转发。无记录则广播。
    
    * 现在最左边的路由器 R1 收到了该帧，确认好是向自己寻址的帧后，向上交给网络层，网络层检查自己的转发表决定转发端口，由于这是子网 1 的网关路由器，因此该网关路由器的 ARP 表中具有目的主机的 MAC 地址 CC-CC-CC-CC-CC-CC，所以将其作为目的 MAC 地址填写。
    
    * 子网 1 的交换机 S1 收到帧，有记录则转发，无记录则广播。
    
    * 目的主机收到向自己寻址的帧，将其拆封，并交给上层协议栈。
    
  * d.
    * 用嘴说一下吧...只是在每台路由器和主机 E 封装链路层帧时都先使用 ARP 查找了 IP 对应的 MAC 地址。并且在此 ARP 请求和应答的过程中，交换机学习到了所有相关路径的 MAC <-> 端口映射关系。

#### P15 考虑图 5-33。现在我们用一台交换机代替子网 1 和子网 2 之间的路由器，并且将子网 2 和子网 3 之间的路由器标记为 R1。
#### a. 考虑从主机 E 向主机 F 发送一个 IP 数据报。主机 E 将请求路由器 R1 帮助转发该数据报吗？为什么？在包含 IP 数据报的以太网帧中，源和目的 IP 和 MAC 地址分别是什么？
#### b. 假定 E 希望向 B 发送一个 IP 数据报，假设 E 的 ARP 缓存中不包含 B 的 MAC 地址。 E 将执行 ARP 查询来发现 B 的 MAC 地址吗？为什么？在交付给路由器 R1 的以太网帧（包含发向 B 的 IP 数据报）中，源和目的 IP 和 MAC 地址分别是什么？
#### c. 假定主机 A 希望向主机 B 发送一个 IP 数据报，A 的 ARP 缓存不包含 B 的 MAC 地址，B 的 ARP 缓存也不包含 A 的 MAC 地址。进一步假定交换机 S1 的转发表仅包含主机 B 和路由器 R1 的表项。因此， A 将广播一个 ARP 请求报文。一旦交换机 S1 收到 ARP 请求报文将执行什么动作？路由器 R1 也会收到这个 ARP 请求报文吗？如果收到的话，R1 将向子网 3 转发该报文吗？一旦主机 B 收到这个 ARP 请求报文，它向主机 A 回发一个 ARP 响应报文。但是它将发送一个 ARP 查询报文来请求 A 的 MAC 地址吗？为什么？一旦交换机 S1 收到来自主机 B 的一个 ARP 响应报文，它将做什么？

  * a.
    * E 因为拥有子网掩码，于是他可以检查到 F 和它属于同一个子网中，因此不会将网关路由器的 IP 地址作为下一跳，而是选择直接将其交给 F。
    
    * 假设 E 的 ARP 表目前为空，于是 E 将执行 ARP 查询操作，借此得到 F 的 MAC 地址 JJ-JJ-JJ-JJ-JJ-JJ，如果 E 检查到 F 和它不属于同一个子网的话，那么这里通过 ARP 查询的就是网关路由器的 MAC 地址。
    
    * 当 ARP 查询操作执行完成后，交换机中已经有了 F 的 MAC 地址对应的表项，以及 E 的 MAC 地址对应的表项，因此当交换机收到 E 打包的帧后，直接将其转发给了 F，而不会交给路由器。
    
    * E 向 F 发送的源 IP 为 192.168.3.2，目的 IP 为 192.168.3.3，源 MAC 地址为 II-II-II-II-II-II，目的 MAC 地址为 JJ-JJ-JJ-JJ-JJ-JJ
    
  * b.
    * E 通过检查自己和 B 不位于同一个子网内，因此将执行 ARP 查询网关路由器的 MAC 地址，而不是 B 的。
    * 源 IP : 192.168.3.2
    * 目的 IP : 192.168.1.3
    * 源 MAC : II-II-II-II-II-II
    * 目的 MAC : HH-HH-HH-HH-HH-HH

  * c.
    * S1 收到该 ARP 查询报文，就会在自己的交换表中添加一条记录，是 A 的 MAC 地址 <-> 端口的映射。
    
    * 路由器 R1 将会收到这个报文，但它不会向子网 3 转发

    * B 不用查询 A 的 MAC 地址，因为在 A 的 ARP 查询报文中，源 MAC 地址就是 A 的 MAC 地址。

    * 交换机 S1 收到 B 的响应报文后，在自己的交换表中添加 B 的 MAC 地址 <-> 端口的映射，并将其转发给 A，因此从 A 的 ARP 查询报文中，交换机已经学习到了 A 的 MAC 地址和响应端口的映射。

#### P16 考虑前面的习题，但是现在假设用一台交换机代替子网 2 和子网 3 之间的路由器，在这种新的场景中回答前面习题中的问题（a）~（c）

  * a.
    * E 检查 F 的 IP 地址，发现它们位于同一个子网内，因此不会发送给网关路由器 R1
    * 源 IP : 192.168.3.2
    * 目的 IP : 192.168.3.3
    * 源 MAC : II-II-II-II-II-II
    * 目的 MAC : JJ-JJ-JJ-JJ-JJ-JJ

  * b.
    * 是的，现在将会执行 ARP 来查找 B 的 MAC 地址。该查询的信息如下
    * 源 IP : 192.168.3.2
    * 目的 IP : 192.168.1.3
    * 源 MAC : II-II-II-II-II-II
    * 目的 MAC : 广播地址 ff-ff-ff-ff-ff-ff

  * c.
    * S1 收到该 ARP 查询报文，就会在自己的交换表中添加一条记录，是 A 的 MAC 地址 <-> 端口的映射。
    
    * 交换机 S2 将会收到这个报文，它会向子网 3 转发

    * B 不用查询 A 的 MAC 地址，因为在 A 的 ARP 查询报文中，源 MAC 地址就是 A 的 MAC 地址。

    * 交换机 S1 收到 B 的响应报文后，在自己的交换表中添加 B 的 MAC 地址 <-> 端口的映射，并将其转发给 A，因此从 A 的 ARP 查询报文中，交换机已经学习到了 A 的 MAC 地址和响应端口的映射。

#### P21 现在考虑习题 P14 中的图 5-33。对主机 A、两台路由器和主机 F 的各个接口提供 MAC 地址和 IP 地址。假定主机 A 向主机 F 发送一个数据报。当在下列场合传输帧时，给出在封装该 IP 数据报的帧中的源和目的 MAC 地址: (i) 从 A 到左边的路由器；(ii) 从左边的路由器到右边的路由器；(iii) 从右边的路由器到 F。还要给出到达每个点时封装在该帧中的 IP 数据报中的源和目的 IP 地址。
![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/p14.2.png)

  * a.
    * 源 IP : 192.168.1.1
    * 目的 IP : 192.168.3.3
    * 源 MAC : AA-AA-AA-AA-AA-AA
    * 目的 MAC : BB-BB-BB-BB-BB-BB
    
  * b.
    * 源 IP : 192.168.1.1
    * 目的 IP : 192.168.3.3
    * 源 MAC : DD-DD-DD-DD-DD-DD
    * 目的 MAC : GG-GG-GG-GG-GG-GG

  * c.
    * 源 IP : 192.168.1.1
    * 目的 IP : 192.168.3.3
    * 源 MAC : HH-HH-HH-HH-HH-HH
    * 目的 MAC : JJ-JJ-JJ-JJ-JJ-JJ

#### P22 现在假定在图 5-33 最左边的路由器被一台交换机替换。主机 A、B、C 和 D 和右边的路由器以星型方式与这台交换机相连。当在下列场合传输该帧时，给出在封装该 IP 数据报的帧中的源和目的 MAC 地址：(i) 从 A 到左边交换机；(ii)从左边交换机到右边的路由器；(iii) 从右边的路由器到 F。还要给出到达每个点时封装在该帧中的 IP 数据报中的源和目的 IP 地址。

![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/p22.png)

  * a.
    * 源 IP : 192.168.1.1
    * 目的 IP : 192.168.3.3
    * 源 MAC : AA-AA-AA-AA-AA-AA
    * 目的 MAC : GG-GG-GG-GG-GG-GG

  * b.
    * 源 IP : 192.168.1.1
    * 目的 IP : 192.168.3.3
    * 源 MAC : AA-AA-AA-AA-AA-AA
    * 目的 MAC : GG-GG-GG-GG-GG-GG

  * c.
    * 源 IP : 192.168.1.1
    * 目的 IP : 192.168.3.3
    * 源 MAC : HH-HH-HH-HH-HH-HH
    * 目的 MAC : JJ-JJ-JJ-JJ-JJ-JJ

#### P26 在某网络中标示为 A 到 F 的 6 个结点以星型与一台交换机连接，考虑在该网络环境中某个正在学习的交换机的运行情况。假定:（i）B 向 E 发送一个帧；(ii) E 向 B 回答一个帧；(iii) A 向 B 发送一个帧；(iv) B 向 A 回答一个帧。该交换机表初始为空。显示在这些事件的前后盖交换机表的状态。对于每个事件，指出在其上转发传输的帧的链路，并简要地评价你的答案。

![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/p26.png)

  * a.
    * 交换机中添加了映射关系 B <-> 6
    * 因为交换机中没有记录，因此广播该帧
    
  * b.
    * 交换机中添加了映射关系 E <-> 3
    * 因为交换机中已经有记录，所以转发帧到 6 端口
  
  * c.
    * 交换机中添加了映射关系 A <-> 1
    * 因为交换机中已经有记录，所以转发到 6 端口
    
  * d.
    * B 向 A 回答时，因为交换机中已经有 A 的映射关系


  