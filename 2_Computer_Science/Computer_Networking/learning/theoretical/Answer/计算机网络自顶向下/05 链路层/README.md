#### 链路层
* 5.1 链路层概述

  * 坐飞机可以从昆明到深圳，坐火车或者坐轮船也可以，不同的交通运输方式类比于不同的链路层协议。
  
  * 5.1.1 链路层提供的服务
  
     * 成帧 : 添加链路层首部，将网络层数据报封装成链路层帧
     
     * 链路接入 : 帧在链路上的传输规则，点对点链路的传输规则，多个结点共享单个广播链路的传输规则。
     
     * 可靠交付 : 通过确认和重传实现，链路层可靠交付通常用于易于产生高差错率的链路，比如无线链路。对于低比特差错链路，比如光纤、同轴电缆和双绞铜线链路，链路层的可靠交付可能被认为是不必要的开销，因此许多有线链路层协议不提供可靠交付服务。
     
     * 差错检测和纠正 : 由于信号衰减和电磁噪声导致的比特翻转和差错，链路层差错检测和纠正的目的是本地检错和纠错，不把错误带入到高层协议栈，链路层的差错检测和纠正比运输层和网络层的更复杂，并且用硬件实现。
     
  * 5.1.2 链路层在何处实现
  
     * 路由器: 链路层协议实现在线路卡中。
     
     * 主机:
       * ![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/link_layer_imp_position.png)
       * 在发送端，控制器取得了协议栈高层生成并存储在主机内存中的数据报，在链路层帧中封装该数据报，然后遵循链路接入协议将该帧传进通信链路中。在接收端，控制器接收了整个帧，抽取出网络层数据报。如果链路层执行差错检测，则发送控制器在该帧首部设置差错检测比特，由接收控制器执行差错检测。
       
* 5.2 差错检测和纠正技术

  * 5.2.1 奇偶校验
  
  	  * 对于二维奇偶校验来说，可以检错并且纠错（只针对一位比特差错来说）
  	 
  * 5.2.2 检验和方法
  
     * 实现 [checksum.c](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/progs/checksum.c)
  
  * 5.2.3 循环冗余检测 (CRC)
  
     * 选择一个生成多项式 G = 10011，那么将原数据 D = 110110111 左移 4 位变成 D = 110110111 0000，然后用 D 模2除以 G，最后将得到的余数 R 附着在 D 因为左移而产生的 0 位上，R 就是 CRC 校验码。
     
     * 每个 CRC 标准都能检测小于 `r+1` 比特的突发差错，在适当的假设下，长度大于 `r+1` 比特的突发差错以概率 `1 - 0.5^r` 被检测到，每个 CRC 标准也能检测任何奇数个比特差错。
  
* 5.3 多路访问链路和协议
  * 好的多路访问协议应该具有以下所希望的特性：
     * 当仅有一个结点有数据发送时，该结点具有 R bps 吞吐量。
     * 当有 M 个结点要发送数据时，每个结点平均吞吐量为 R/M bps。
     * 协议是分散的；不会因为某个主结点故障而使整个系统崩溃。
     * 协议是简单的，实现不昂贵。 
     
  * 5.3.1 信道划分协议
     * TDM (时分)
       *  话筒给你，老王，你来说 2 秒钟
       *  话筒给你，老李，你来说 2 秒钟
       *  ...
       
     * FDM (频分)
       *  老李，这个 topic 由你来说
       *  老王，这个 topic 由你来说
       *  ...
       
     * CDMA （码分多址）
       * 不懂...
  
  * 5.3.2 **随机接入协议**
     * 在随机接入协议中，一个传输结点总是以信道全部速率 R bps 发送，当碰撞时，涉及碰撞的每个结点反复重发它的帧，直到该帧无碰撞通过。但结点在经历碰撞后，不必立刻重发，而是等待一个随机时延。
     
     * **时隙 ALOHA**
        * 当结点有新帧要发送，那么它等到下一个时隙开始并在该时隙内传输整个帧
        * 如果没有碰撞，传输成功
        * 如果有碰撞，该结点在时隙结束之前检测到该碰撞，该结点在后续每个时隙中以概率 p 重传该帧
        * 时隙 ALOHA 的最大效率为 1/e = 0.37
       
     * **纯 ALOHA**
       * 不等待时隙，不同步结点间的时隙，立刻开始传输帧。
       * 如果发生碰撞，则等待一个帧传输时间，然后以概率 p 重传。
       * 如果无碰撞，传输成功
       * 纯 ALOHA 的最大效率为 1/2e = 0.185
       
     * **CSMA/CD**
       * ⚠️ CSMA 就是在传输时不检测碰撞
       * 1、适配器从网络层获得数据报，准备链路层帧，并将其放入帧适配器缓存中。
       * 2、如果适配器帧听到信道空闲（即无信号能量从信道进入适配器）则等待 96 比特时间（帧间最小时间间隙）后开始传输帧，如果帧听到信道忙，则等待直到信道空闲时才开始传输帧。
       * 3、在传输过程中，适配器监视使用该广播信道的其他适配器信号能量的存在。
       * 4、如果适配器传输完整个帧而未检测到来自其他适配器的信号能量，则完成该帧传输，若传输时检测到其他适配器的信号能量，则在传输完一个 48 比特的强化干扰信号后中止传输。
       * 5、中止传输后，使用二进制指数后退算法等待一个随机时间量，然后回到步骤 2
  
  * 5.3.3 轮流协议
     * 轮询协议
        * 主结点询问给定结点: 
        * “你要是有要发送的数据，你最多发 Q 比特，发完告诉我。如果没数据要发，立马告诉我”。
        * 于是从上一个结点发送完成，将完成信号传递给主结点，到主结点给下一结点的命令传达到位为止，所经历的时延是 `d_poll`。因此，对于每个结点来说，都引入了一个 `d_poll`。
        * 因此若有 N 个结点，则轮询一遍所有结点，假如都有数据要发送，则总耗时为 `N(Q/R + d_poll)`
       * 总发送的数据量为 `NQ`，因此总吞吐量为总发送数据量除以总耗时如下：
       * `NQ/N(Q/R + d_poll)`
       * `Q/(Q/R + d_poll)`
     
     * 令牌传递协议
        * 初始化环
        * 将令牌沿着物理链路单向逐站传递
        * 如果 A 要说话，那么必须等到令牌传到 A 这里
        * 当 A 拿到令牌时，A 传送帧，并开启一个定时器 Token Holding Timer，A 传送的帧沿着环被每个结点接收到，但只有 MAC 地址匹配的才复制该帧。
        * 当 A 传送的帧传播了一整圈重新回到 A 后，A 看一下 THT 是否超时，如果超时那么即便自己还有话要说，也只能把令牌释放传给下一个结点，如果未超时，那么 A 可以继续说话。
        * 从令牌环网的工作方式可以看出，令牌需要在 A 的帧绕环一整圈后才能被 A 释放，因此当局域网有很大的周长时，绕一阵圈相当耗时，下一个结点要等好久才能轮到自己说话。
  
  * 5.3.4 DOCSIS
     * ![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/DOCSIS.png)
     
     * 上行信道被 CMTS 使用 TDM 划分，一组时隙为特殊请求帧时隙；一组时隙为数据帧时隙。调制电缆解调器在请求帧时隙间隔内向 CMTS 发送请求帧来告知 CMTS 自己有数据要发送。
     
     * 接下来 CMTS 在下行信道通过发送 MAP 控制报文，指定哪个电缆调制解调器能够在数据时隙中传输由控制报指定的时间间隔。由于上行信道的数据时隙的使用是由 CMTS 指定的，故不会发生碰撞。
     
     * CMTS 下行信道只有 CMTS 一个发言者，也不存在碰撞问题。
     
     * 唯一可能产生碰撞的地方是电缆调制解调器向 CMTS 发送请求帧所用的时隙，这里的电缆调制解调器既不侦听上行信道是否忙，也不检测碰撞。相反，它如果在下一个下行控制报文中没有收到对请求分配的响应的话，就认为经历了一次碰撞，那么电缆调制解调器使用二进制指数回退等待一个时间，再发送请求帧。 
  
* 5.4 交换局域网
  * 5.4.1 链路层寻址和 ARP
     * 1、MAC 地址
        * MAC 地址是身份证号码，IP 地址是快递地址。
     * 2、ARP
        * 查询 IP 对应的 MAC 地址
     * 3、发送数据报到子网以外
        * 跨网段时，目的 MAC 填写的是网关路由器的 MAC 而不是目的主机的 MAC。
  * 5.4.2 以太网
     * 1、以太网帧结构
        * ![](https://github.com/YangXiaoHei/Networking/blob/master/计算机网络自顶向下/05%20链路层/images/ethernet_frame_structure.png)
        
        * **数据字段** ：46 ~ 1500 字节,如果 IP 数据报超过 1500 字节，则主机必须将数据报分片，如果 IP 数据报小于 46 字节，则必须被填充到 46 字节。因为以太网的 10 Mbps 最大 RTT 是 57.6 us，因此为了碰撞一定能被能被侦测到 (即在传输完一个帧前能收到对端发来的碰撞信号)，需要满足 `L/R >= 57.6 us`，所以 `L >= 72 bytes`，即 IP 数据报最小为 `72 - 26 = 46 bytes` 。
            * ⚠️注意：Wireshake 捕获到的帧长度会小于 72 字节，这是因为 Wireshake 没有拿到帧的第一手信息。链路层大部分功能用硬件实现，网卡中的适配器将前同步码同步完时间，CRC 检错完就去掉了，不会将其传上来，并且 Wireshake 会将多余的填充字段去掉。
        * **@20190131 17:50 补充**:
            * **MSS** 之所以存在是因为 MTU，MTU 限制了 IP 数据报的长度范围，因此也限制了 TCP 报文段的长度范围，也就限制了应用层报文的最大范围。
            * MTU 上限的存在，基于下列两个原因:
               * 丢包和差错发生在大包上的概率大于小包，因此包长不能无上限增加。
               * CSMA/CD 采用的策略是先侦听信道有没有被使用，若被使用就让发送者独占信道而不去打扰，如果帧长过大，那么一个发送者将会很长时间占用信道，这对于其他潜在的信道使用者来说不公平。
            * MTU 下限的存在，基于下列两个原因:
               * 小分组不利用提高信道的使用率，因为间隙的存在，所以包长不能过小。
               * CSMA/CD 必须在传输完一个帧前监听到是否有碰撞事件的发生，因此帧长有一个最小下限。
        
        * **目的 MAC** ：若接收方收到的 MAC 不是广播 MAC 或者自己的 MAC，那么它直接丢弃该帧。
        
        * **源 MAC** : 发送方自己的 MAC
        
        * **类型字段** : 上层协议是什么
        
        * **CRC** : 用于让接收适配器检错
        
        * **前同步码** : 接收适配器通过锁定前同步码的前 7 个字节，就可以锁定发送适配器的时钟，达到接收适配器的时钟和发送适配器时钟同步的效果。前同步码的第 8 个字节的最后两个比特（两个连续的 1）警告接收适配器，“重要的内容”就要来了！。
        
     * 2、以太网技术 
  * 5.4.3 链路层交换机
     * 1、交换机转发和过滤
        * 交换机的过滤和转发借助于交换机表完成
        * 目的 MAC 为 DD-DD-DD-DD-DD-DD 的从接口 x 到达：
        
           * 若交换表中有 DD-DD-DD-DD-DD-DD 与 y != x 关联，则将帧转发到接口 y 前面的输出缓存。
           
           * 若交换表中有 DD-DD-DD-DD-DD-DD 与 x 关联，则丢弃该帧
           
           * 若交换表中没有 DD-DD-DD-DD-DD-DD 项，则交换机向除了接口 x 外所有接口前的输出缓存转发该帧的副本，即广播该帧。 
           
     * 2、自学习
        * 当帧到达交换机接口 x 时，交换机就会将该帧的源 MAC 和 x 作为一个映射对缓存进交换表，如果一段时间后，交换机没有接收到以该地址作为源地址的帧，就在表中删除这个地址。
        
     * 3、链路层交换机的性质
        * 消除碰撞 : 使用交换机（而不使用集线器）构建的局域网中，没有因碰撞而浪费的带宽，因为交换机是全双工通信，在向目的 MAC A 发送帧时，也可以接收该 MAC A 发来的帧，并且交换机是存储转发的，而集线器是每个 bit 转发，因此会将来自不同接口的帧混杂在一起形成碰撞。
       
        * 异质的链路 : 交换机将链路彼此隔离，因此局域网中的不同链路能够以不同的速率运行并且能够在不同的媒体上运行，因此，对于原有的设备与新设备混用，交换机是理想的。

     * 4、交换机毒化
        * 向交换机发送大量具有不同伪造源的 MAC 地址的分组，因此伪造表很快就填满了交换机表，没有为合法主机留下空间。
  * 5.4.4 虚拟局域网
* 5.5 链路虚拟化: 网络作为链路层
  * 多协议标签交换
* 5.6 数据中心网络
  * 5.6.1 负载均衡
  * 5.6.2 等级体系结构
  * 5.6.3 数据中心网络的发展趋势
* 5.7 回顾: Web 页面请求的历程
  * 5.7.1 准备: DHCP、UDP、IP 和以太网
  * 5.7.2 仍在准备: DNS 和 ARP
  * 5.7.3 仍在准备: 域内路选择到 DNS 服务器
  * 5.7.4 Web 客户 - 服务器交互: TCP 和 HTTP
